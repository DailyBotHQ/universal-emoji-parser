name: Check Branches State

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 2'

jobs:
  check_branches_state:
    name: 'Check Branches State'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.AUTOMATION_GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Step 1 - ⚙️ Setup GitHub Config
        run: |
          git config user.name "🤖 DailyBot"
          git config user.email "ops@dailybot.com"
          echo "${{ secrets.AUTOMATION_GITHUB_TOKEN }}" | gh auth login --with-token
      - name: Step 2 - Get all branches of the repository and check if they are up to date
        run: |
          branches=$(git branch -r)
          for branch in $branches
          do
            author=$(git show --no-patch --format='%an (%ae)' "$branch")
            last_commit_date=$(git show --no-patch --format='%ci' "$branch")
            days_since_last_commit=$(( ( $(date +%s) - $(date -d "$last_commit_date" +%s) ) / 86400 ))
            branch_creation_date=$(git reflog show --date=iso | tail -1 | awk '{print $2" "$3}')
            days_since_branch_creation=$(( ( $(date +%s) - $(date -d "$branch_creation_date" +%s) ) / 86400 ))

            echo "$branch by $author is older than $DAYS_FROM_LAST_COMMIT_TO_NOTIFY days, and it has been $days_since_branch_creation days since it was created"

            DAYS_FROM_LAST_COMMIT_TO_NOTIFY=5
            if (( days_since_last_commit > $DAYS_FROM_LAST_COMMIT_TO_NOTIFY ))
            then
              echo "$branch by $author is older than $DAYS_FROM_LAST_COMMIT_TO_NOTIFY days, and it has been $days_since_branch_creation days since it was created"
            fi
          done
