name: Check Branches State

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 2'

jobs:
  check_branches_state:
    name: 'Check Branches State'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.AUTOMATION_GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Step 1 - ⚙️ Setup GitHub Config
        run: |
          git config user.name "🤖 DailyBot"
          git config user.email "ops@dailybot.com"
          echo "${{ secrets.AUTOMATION_GITHUB_TOKEN }}" | gh auth login --with-token
      - name: Step 2 - Get all branches of the repository and check if they are up to date
        run: |
          branches=$(git branch -r | cut -f2 -d' ')
          echo "Checking branches state..."
          echo "Branches: $branches"

          for branch in $branches
          do
            author=$(git show --no-patch --format='%an' "$branch")
            last_commit_date=$(git show --no-patch --format='%ci' "$branch")
            days_since_last_commit=$(( ( $(date +%s) - $(date -d "$last_commit_date" +%s) ) / 86400 ))

            if (( days_since_last_commit > 0 ))
            then
              echo "$branch by $author is older than 0 days"
            fi
          done
